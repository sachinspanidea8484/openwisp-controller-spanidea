{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block extrahead %}
{{ block.super }}
<style>
    /* Reset and Base Styles */
    .test-execution-history {
        font-family: "Roboto", "Helvetica Neue", Arial, sans-serif;
        color: #333;
    }

    /* OpenWISP Standard Module Section */
    .module {
        background: #fff;
        border: 1px solid #e3e3e3;
        border-radius: 4px;
        margin-bottom: 20px;
        overflow: hidden;
    }

    .module h2 {
        margin: 0;
        padding: 12px 20px;
        background: #f8f8f8;
        border-bottom: 1px solid #e3e3e3;
        font-size: 13px;
        text-transform: uppercase;
        font-weight: 500;
        color: #666;
        letter-spacing: 0.5px;
    }

    /* Summary Card - OpenWISP Style */
    .summary-content {
        padding: 20px;
    }

    .summary-row {
        display: flex;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .summary-row:last-child {
        border-bottom: none;
    }

    .summary-label {
        flex: 0 0 180px;
        font-weight: 500;
        color: #666;
        font-size: 13px;
    }

    .summary-value {
        flex: 1;
        color: #333;
        font-size: 13px;
    }

    .summary-value a {
        color: #0066cc;
        text-decoration: none;
    }

    .summary-value a:hover {
        text-decoration: underline;
    }

    /* OpenWISP Status Indicators */
    .status-indicator {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .status-indicator.success {
        background: #dff0d8;
        color: #3c763d;
        border: 1px solid #d6e9c6;
    }

    .status-indicator.failed {
        background: #f2dede;
        color: #a94442;
        border: 1px solid #ebccd1;
    }

    .status-indicator.pending {
        background: #fcf8e3;
        color: #8a6d3b;
        border: 1px solid #faebcc;
    }

    .status-indicator.running {
        background: #d9edf7;
        color: #31708f;
        border: 1px solid #bce8f1;
    }

    /* Device Cards - OpenWISP Style */
    .device-card {
        border: 1px solid #e3e3e3;
        border-radius: 4px;
        margin-bottom: 15px;
        background: #fff;
    }

    .device-header {
        background: #f8f8f8;
        border-bottom: 1px solid #e3e3e3;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .device-title {
        font-size: 14px;
        font-weight: 500;
        color: #333;
        margin: 0;
    }

    .device-stats {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .stat-item {
        font-size: 12px;
        color: #666;
    }

    .stat-value {
        font-weight: 500;
        color: #333;
    }

    /* Progress Bar - OpenWISP Style */
    .progress-container {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .progress-bar {
        width: 100px;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: #5cb85c;
        transition: width 0.3s ease;
    }

    .progress-fill.warning {
        background: #f0ad4e;
    }

    .progress-fill.danger {
        background: #d9534f;
    }

    .progress-text {
        font-size: 12px;
        color: #666;
        white-space: nowrap;
    }

    /* Test Results Table - OpenWISP Style */
    .results-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }

    .results-table thead th {
        background: #fafafa;
        border-bottom: 1px solid #e3e3e3;
        padding: 10px 15px;
        text-align: left;
        font-weight: 500;
        color: #666;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .results-table tbody td {
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
        color: #333;
    }

    .results-table tbody tr:hover {
        background: #fafafa;
    }

    .results-table tbody tr:last-child td {
        border-bottom: none;
    }

    .test-id-badge {
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 11px;
        background: #f5f5f5;
        padding: 2px 6px;
        border-radius: 3px;
        color: #666;
    }

    /* Action Buttons - OpenWISP Style */
    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .btn-action {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border: 1px solid #ddd;
        background: #fff;
        color: #333;
        font-size: 12px;
        font-weight: 400;
        border-radius: 3px;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-action:hover {
        background: #f8f8f8;
        border-color: #ccc;
    }

    .btn-action.primary {
        background: #0066cc;
        color: #fff;
        border-color: #0066cc;
    }

    .btn-action.primary:hover {
        background: #0052a3;
        border-color: #0052a3;
    }

    .btn-action.warning {
        background: #f0ad4e;
        color: #fff;
        border-color: #f0ad4e;
    }

    .btn-action.warning:hover {
        background: #ec971f;
        border-color: #ec971f;
    }

    .btn-action[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-icon {
        width: 14px;
        height: 14px;
    }

    /* Error Message - OpenWISP Style */
    .error-section {
        background: #f2dede;
        border-top: 1px solid #ebccd1;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .error-text {
        color: #a94442;
        font-size: 13px;
        flex: 1;
        margin-right: 20px;
    }

    /* Loading State - OpenWISP Style */
    .loading-container {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }

    .spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #0066cc;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
        font-style: italic;
        font-size: 13px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .summary-row {
            flex-direction: column;
        }
        
        .summary-label {
            flex: none;
            margin-bottom: 5px;
        }
        
        .device-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        .device-stats {
            width: 100%;
            justify-content: space-between;
        }
    }

    /* Additional OpenWISP alignments */
    h1 {
        font-size: 24px;
        margin: 0 0 20px 0;
        font-weight: 300;
        color: #333;
    }

    .breadcrumbs {
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:test_management_testsuiteexecution_changelist' %}">{% trans 'Test Executions' %}</a>
    &rsaquo; {% trans 'Execution History' %}
</div>
{% endblock %}

{% block content %}
<div class="test-execution-history">

    <!-- Loading State -->
    <div id="loading" class="loading-container">
        <div class="spinner"></div>
        <p>{% trans 'Loading execution history...' %}</p>
    </div>

    <!-- Main Content -->
    <div id="main-content" style="">
        <!-- Execution Summary Module -->
        <div class="module">
            <h2>{% trans 'Execution Summary' %}</h2>
            <div class="summary-content">
                <div id="summary-rows">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Device Executions Module -->
        <div class="module">
            <h2>{% trans 'Device Execution Details' %}</h2>
            <div id="device-executions" style="padding: 20px;">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
// CSRF token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');
const executionId = '{{ execution_id }}';

// Display execution data with OpenWISP styling
function displayExecutionData(data) {
    // Update page title
    
    // Update summary
    const summaryRows = document.getElementById('summary-rows');
    summaryRows.innerHTML = `
        <div class="summary-row">
            <div class="summary-label">Test Group:</div>
            <div class="summary-value">
                <a href="/admin/test_management/testsuite/${data.test_suite_id}/change/">
                    ${data.test_suite_name}
                </a>
            </div>
        </div>
        <div class="summary-row">
            <div class="summary-label">Category:</div>
            <div class="summary-value">${data.category_name}</div>
        </div>
        <div class="summary-row">
            <div class="summary-label">Total Devices:</div>
            <div class="summary-value">${data.total_devices}</div>
        </div>

        <div class="summary-row">
            <div class="summary-label">Execution Status:</div>
            <div class="summary-value">
                <span class="status-indicator ${data.is_executed ? 'success' : 'pending'}">
                    ${data.is_executed ? 'Executed' : 'Pending'}
                </span>
            </div>
        </div>

    `;
    
    // Display device executions
    const deviceExecutionsDiv = document.getElementById('device-executions');
    
    if (data.devices && data.devices.length > 0) {
        let devicesHtml = '';
        
        data.devices.forEach(device => {
            // Calculate progress percentage
            const stats = device.statistics;
            const progressPercentage = stats.total > 0 ? stats.percentage : 0;
            let progressClass = '';
            if (progressPercentage === 100 && stats.failed === 0) {
                progressClass = '';
            } else if (stats.failed > 0) {
                progressClass = 'danger';
            } else {
                progressClass = 'warning';
            }
            
                        // Build test results table
            let testResultsHtml = '';
            if (device.test_cases && device.test_cases.length > 0) {
                let tableRows = '';
                
                device.test_cases.forEach(test => {
                    let actions = '';
                    
                    // Download log button
                    if (test.has_log && (test.status === 'success' || test.status === 'failed')) {
                        actions += `
                            <a href="/api/v1/test-management/test-case-execution/${test.id}/download-log/" 
                               class="btn-action" 
                               title="Download log">
                                <svg class="btn-icon" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M13 8V2H7v6H2l8 8 8-8h-5zM0 18h20v2H0v-2z"/>
                                </svg>
                                Log
                            </a>
                        `;
                    }
                    
                    // Retry button
                    if (test.can_retry) {
                        actions += `
                            <button class="btn-action warning" 
                                    onclick="retryTest('${test.id}')" 
                                    title="Retry test">
                                <svg class="btn-icon" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 3v2a5 5 0 0 0-3.54 8.54l-1.41 1.41A7 7 0 0 1 10 3zm4.95 2.05A7 7 0 0 1 10 17v-2a5 5 0 0 0 3.54-8.54l1.41-1.41zM10 20l-4-4 4-4v8zm0-12V0l4 4-4 4z"/>
                                </svg>
                                Retry
                            </button>
                        `;
                    }
                    
                    tableRows += `
                        <tr>
                            <td>${test.test_case_name || 'N/A'}</td>
                            <td><span class="test-id-badge">${test.test_case_id || 'N/A'}</span></td>
                            <td>${test.test_type || 'N/A'}</td>
                            <td>
                                <span class="status-indicator ${test.status}">
                                    ${test.status_display || test.status}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    ${actions || '-'}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                testResultsHtml = `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Test Case</th>
                                <th>Test ID</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                `;
            } else {
                testResultsHtml = '<div class="empty-state">No test results available for this device.</div>';
            }
            
            // Build error section if needed
            let errorHtml = '';
            if (device.device_execution_status === 'failed' && device.error_message) {
                const errorText = device.error_message.substring(0, 200);
                // errorHtml = `
                //     <div class="error-section">
                //         <div class="error-text">
                //             <strong>Error:</strong> ${errorText}${device.error_message.length > 200 ? '...' : ''}
                //         </div>
                //         <button class="btn-action warning" 
                //                 onclick="retryDeviceTests('${device.device_execution_id}')" 
                //                 title="Retry all failed tests">
                //             <svg class="btn-icon" fill="currentColor" viewBox="0 0 20 20">
                //                 <path d="M10 3v2a5 5 0 0 0-3.54 8.54l-1.41 1.41A7 7 0 0 1 10 3zm4.95 2.05A7 7 0 0 1 10 17v-2a5 5 0 0 0 3.54-8.54l1.41-1.41zM10 20l-4-4 4-4v8zm0-12V0l4 4-4 4z"/>
                //             </svg>
                //             Retry All Failed
                //         </button>
                //     </div>
                // `;

                 errorHtml = ``;
            }
            
            // Build device card
            devicesHtml += `
                <div class="device-card">
                    <div class="device-header">
                        <h3 class="device-title">${device.device_name || 'Unknown Device'}</h3>
                        <div class="device-stats">
                            <div class="progress-container">
                                <span class="progress-text">${stats.success}/${stats.total} passed</span>
                                <div class="progress-bar">
                                    <div class="progress-fill ${progressClass}" style="width: ${progressPercentage}%"></div>
                                </div>
                            </div>
                            <span class="status-indicator ${stats.overall_status}">
                                ${stats.overall_status}
                            </span>
                        </div>
                    </div>
                    <div style="padding: 20px;">
                        ${testResultsHtml}
                    </div>
                     ${errorHtml}
                </div>
            `;
        });
        
        deviceExecutionsDiv.innerHTML = devicesHtml;
    } else {
        deviceExecutionsDiv.innerHTML = '<div class="empty-state">No device executions found.</div>';
    }
}

// Simplified retry function without CSRF token
// Update the retryTest function
function retryTest(executionId) {
    if (!confirm('Are you sure you want to retry this test?')) {
        return;
    }
    
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    button.innerHTML = '<span class="spinner" style="width: 12px; height: 12px; border-width: 2px;"></span> Retrying...';
    button.disabled = true;
    
    fetch(`/api/v1/test-management/test-case-execution/${executionId}/retry/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,  // Make sure this is included
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin',  // Important for CSRF
        body: JSON.stringify({})
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showMessage('Test retry initiated successfully', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showMessage(data.error || 'Failed to retry test', 'error');
            button.innerHTML = originalContent;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Retry error:', error);
        showMessage(error.detail || error.message || 'Failed to retry test', 'error');
        button.innerHTML = originalContent;
        button.disabled = false;
    });
}

// Update the retryDeviceTests function similarly
function retryDeviceTests(deviceExecutionId) {
    if (!confirm('Are you sure you want to retry all failed tests for this device?')) {
        return;
    }
    
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    button.innerHTML = '<span class="spinner" style="width: 12px; height: 12px; border-width: 2px;"></span> Processing...';
    button.disabled = true;
    
    fetch(`/api/v1/test-management/device-execution/${deviceExecutionId}/retry-all/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,  // Make sure this is included
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin',  // Important for CSRF
        body: JSON.stringify({})
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showMessage(`${data.retried_count} tests queued for retry`, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showMessage(data.error || 'Failed to retry device tests', 'error');
            button.innerHTML = originalContent;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Retry error:', error);
        showMessage(error.detail || error.message || 'Failed to retry device tests', 'error');
        button.innerHTML = originalContent;
        button.disabled = false;
    });
}
// OpenWISP style message display
function showMessage(message, type) {
    // Remove any existing messages
    const existingMsg = document.querySelector('.messagelist');
    if (existingMsg) {
        existingMsg.remove();
    }
    
    // Create message element
    const msgClass = type === 'success' ? 'success' : 'error';
    const msgHtml = `
        <ul class="messagelist">
            <li class="${msgClass}">${message}</li>
        </ul>
    `;
    
    // Insert after h1
    const h1 = document.querySelector('h1');
    h1.insertAdjacentHTML('afterend', msgHtml);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        const msg = document.querySelector('.messagelist');
        if (msg) {
            msg.style.opacity = '0';
            setTimeout(() => msg.remove(), 300);
        }
    }, 5000);
}

// Load execution history
function loadExecutionHistory() {
    fetch(`/api/v1/test-management/execution/${executionId}/history/`, {
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            displayExecutionData(data.data);
            
            // Show content with smooth transition
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                document.getElementById('main-content').style.opacity = '0';
                
                // Fade in
                setTimeout(() => {
                    document.getElementById('main-content').style.transition = 'opacity 0.3s ease-in';
                    document.getElementById('main-content').style.opacity = '1';
                }, 10);
            }, 100);
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('loading').innerHTML = `
            <div style="color: #a94442; text-align: center; padding: 40px;">
                <h3>Error Loading Data</h3>
                <p>${error.message}</p>
                <button onclick="location.reload()" 
                        class="btn-action primary" 
                        style="margin-top: 20px; padding: 8px 20px;">
                    Reload Page
                </button>
            </div>
        `;
    });
}

// Auto-refresh management
let refreshInterval = null;
let isPageVisible = true;

function startAutoRefresh() {
    if (!refreshInterval && isPageVisible) {
        refreshInterval = setInterval(() => {
            if (isPageVisible) {
                loadExecutionHistory();
            }
        }, 30000); // 30 seconds
    }
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

// Handle page visibility
document.addEventListener('visibilitychange', function() {
    isPageVisible = !document.hidden;
    if (!isPageVisible) {
        stopAutoRefresh();
    } else {
        // Check if we should restart auto-refresh
        const hasPending = document.querySelectorAll('.status-indicator.pending, .status-indicator.running').length > 0;
        if (hasPending) {
            startAutoRefresh();
        }
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadExecutionHistory();
    
    // Start auto-refresh after initial load if there are pending/running tests
    setTimeout(() => {
        const hasPending = document.querySelectorAll('.status-indicator.pending, .status-indicator.running').length > 0;
        if (hasPending) {
            startAutoRefresh();
        }
    }, 2000);
});

// Add OpenWISP message styles
const messageStyles = document.createElement('style');
messageStyles.textContent = `
    .messagelist {
        margin: 0 0 20px 0;
        padding: 0;
        list-style: none;
    }
    
    .messagelist li {
        padding: 12px 20px;
        margin: 0;
        font-size: 13px;
        border-radius: 4px;
    }
    
    .messagelist li.success {
        background: #dff0d8;
        color: #3c763d;
        border: 1px solid #d6e9c6;
    }
    
    .messagelist li.error {
        background: #f2dede;
        color: #a94442;
        border: 1px solid #ebccd1;
    }
    
    .messagelist {
        transition: opacity 0.3s ease;
    }
`;
document.head.appendChild(messageStyles);

</script>
{% endblock %}

{% block submit_buttons_bottom %}{% endblock %}